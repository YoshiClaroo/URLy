<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Acortador de URLs</title>
  <style>
    body {
      background: #ffffff;
      color: #1d4ed8;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 1em;
      border: 1px solid #1d4ed8;
      border-radius: 5px;
    }
    button {
      background: #1d4ed8;
      color: white;
    }
    .url-item {
      margin-top: 10px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Acortador de URLs</h1>
  <input type="text" id="alias" placeholder="Tu alias">
  <input type="text" id="longUrl" placeholder="URL larga">
  <button id="shortenBtn">Acortar</button>
  <div id="result"></div>
  <h2>Mis URLs</h2>
  <div id="urlsList"></div>

  <script type="module">
    import { db } from './firebase.js';
    import { collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    function generateShortId(length = 6) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    document.getElementById('shortenBtn').addEventListener('click', async () => {
      const alias = document.getElementById('alias').value.trim();
      const longUrl = document.getElementById('longUrl').value.trim();
      if (!alias || !longUrl) return alert("Ingresa alias y URL");

      const shortId = generateShortId();
      const shortUrl = `${window.location.origin}/redirect.html?c=${shortId}`;

      await addDoc(collection(db, "urls"), {
        alias,
        longUrl,
        shortId,
        createdAt: serverTimestamp(),
        clicks: 0
      });

      document.getElementById('result').innerHTML = `
        <p><strong>URL acortada:</strong> <a href="${shortUrl}" target="_blank">${shortUrl}</a></p>
      `;
      loadUrls();
    });

    async function loadUrls() {
      const snapshot = await getDocs(collection(db, "urls"));
      const container = document.getElementById("urlsList");
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const shortUrl = `${window.location.origin}/redirect.html?c=${d.shortId}`;
        const createdAt = d.createdAt?.seconds ? new Date(d.createdAt.seconds * 1000).toLocaleString() : 'Desconocido';

        const item = document.createElement("div");
        item.className = "url-item";
        item.innerHTML = `
          <p><strong>Alias:</strong> ${d.alias}</p>
          <p><strong>Original:</strong> ${d.longUrl}</p>
          <p><strong>Acortada:</strong> <a href="${shortUrl}" target="_blank">${shortUrl}</a></p>
          <p><strong>Creado:</strong> ${createdAt}</p>
          <p><strong>Vistas:</strong> ${d.clicks}</p>
          <button onclick="navigator.clipboard.writeText('${shortUrl}')">Copiar</button>
        `;
        container.appendChild(item);
      });
    }

    loadUrls();
  </script>
</body>
</html>
